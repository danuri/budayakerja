<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Bootstrap demo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <style media="screen">
    body {
      background-color: #0c6063;
      color: #fff;
    }
    .container {
      margin-top: 80px;
      margin-bottom: 50px;
    }

    .card {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-success">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Budaya Kerja</a>
    </div>
  </nav>
  <main class="container">
    <div id="questioner">
      Memuat...
    </div>
    <div class="row" id="choicepelaksana" style="display: none;">
        <div class="col-6">
            <div class="card text-center">
                <div class="card-body">
                  <h5 class="card-title">Pimpinan</h5>
                  <p class="card-text">Isi survey penilaian budaya kerja terhadap pimpinan</p>
                  <a href="javascript:;" class="btn btn-primary" onclick="getquestion('pimpinan')">Isi Survey</a>
                </div>
              </div>
        </div>
        <div class="col-6">
            <div class="card text-center">
                <div class="card-body">
                  <h5 class="card-title">Tim</h5>
                  <p class="card-text">Isi survey penilaian budaya kerja terhadap rekan tim</p>
                  <a href="javascript:;" class="btn btn-primary" onclick="getquestion('tim')">Isi Survey</a>
                </div>
              </div>
        </div>
    </div>

    <div class="row" id="choicekepala" style="display: none;">
        <div class="col-12">
            <div class="card text-center">
                <div class="card-body">
                  <h5 class="card-title">PPIH</h5>
                  <p class="card-text">Isi survey penilaian budaya kerja terhadap pelaksana PPIH</p>
                  <!-- <p class="text-danger">Belum mengisi</p> -->
                  <a href="javascript:;" class="btn btn-primary" onclick="getquestion('ppih')">Isi Survey</a>
                </div>
              </div>
        </div>
    </div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


  <script type="text/javascript">

    var jwt = parseJwt(getCookie('token'));

    if(jwt.jabatan_tugas == 'KEPALAx'){
        document.getElementById("questioner").style.display = "none";
        document.getElementById("choicekepala").style.display = "";
    }else{
        document.getElementById("questioner").style.display = "none";
        document.getElementById("choicepelaksana").style.display = "";
    }

  function beginsubmit() {
    Swal.showLoading();
    var jwt = parseJwt(getCookie('token'));
    const storage = JSON.parse(localStorage.getItem("question"));
    const listsoal = storage.data[0].list_soal;

    var jawabans = [];
    for (var i = 0, len = listsoal.length; i < len; ++i) {
        console.log(listsoal[i].soal_kuesioner);

        element = document.querySelector('input[name="quest'+listsoal[i].soal_kuesioner+'"]:checked');
        if (element != null) {
            var jkues = element.value;
        }else{
            Swal.fire({
            icon: "error",
            title: "Oops...",
            text: "Silahkan isi semua pertanyaan!"
            });
            return false;
        }        

        jawabans[i] = {"soal_kuesioner":listsoal[i].soal_kuesioner, "jawaban_kuesioner":jkues};
    }

    // var obj = new Object();
    // obj.petugas = jwt.no_pendaftaran;
    // obj.kuesioner  = storage.data[0].kuesioner;
    // obj.list_jawaban = jawabans;
    // var jsonString= JSON.stringify(obj);

    console.log(jsonString);

    axios.post('https://haji.kemenag.go.id/ptgsapi/dev/petugashaji/penkin/submit_kuesioner', {
        petugas: jwt.no_pendaftaran,
        kuesioner: storage.data[0].kuesioner,
        jawaban: jawabans
    })
    .then(function (response) {
        Swal.fire({
            title: "Good job!",
            text: "Anda telah mengisi survey!",
            icon: "success"
        }).then((result) => {
            location.reload();
        });
    })
    .catch(function (error) {
        alert("Terdapat gangguan saat mengirim data. Silahkan coba kembali.");
    });
  }

  function checkstorage() {
    let f = localStorage.getItem("question");
    console.log(f);
  }


  function getquestion(jenis) {
    // Swal.fire("Sedang memuat data!");
    Swal.showLoading();
    const element = document.getElementById("questioner");

    let config = {
      method: 'get',
      maxBodyLength: Infinity,
      url: 'https://haji.kemenag.go.id/ptgsapi/dev/petugashaji/penkin/getlist_kuesioner/'+jenis,
      headers: {
        'x-key': '!@4n)$*^nGnal123@#5npPKU',
        'x-access-key': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Imp1bGFlaGEiLCJyb2xlX2lkIjozLCJub19wZW5kYWZ0YXJhbiI6IjQ1MDAwMTIiLCJqZW5pc190dWdhc19sYXRlc3QiOiJLT05TIiwiamFiYXRhbl90dWdhcyI6IktFUEFMQSIsImZ1bGxuYW1lIjoiSlVMQUVIQSIsImVtYWlsIjoianVsYWVoYUBtYWlsLmNvbSIsImthbndpbF9wcm92aW5zaSI6bnVsbCwia2Fud2lsX2tvdGEiOm51bGwsIm5hbWFfa2Fud2lsIjpudWxsLCJ0YWh1bl9oYWppX25hbWUiOiIxNDQ1IEgvMjAyNCBNIiwiaWF0IjoxNzE4MDExMTc4LCJleHAiOjE3NDEzMzkxNzh9.xLgcS43nTMnIkUYEOCbusazvF05J-4J_ru74W_fS_b0',
      }
    };

    axios.request(config)
    .then((response) => {
      // console.log(JSON.stringify(response.data.data));
      const objJSON = response.data.data[0].list_soal;
    //   document.cookie = "question="+objJSON;
    
      localStorage.setItem("question", JSON.stringify(response.data));
      // const obj = JSON.parse(response.data.data);
      // console.log(obj);
      element.innerHTML = '';
      element.innerHTML = '<h4>Isi semua pertanyaan</h4>';
      for (var i = 0, len = objJSON.length; i < len; ++i) {
         var quest = objJSON[i];
         console.log(quest);
         // $("<div id=\"" + student.id + "\">" + student.full_name + " (" + student.user_id + " - " + student.stin + ")</div>")...
         element.innerHTML +=
         `<div class="card">
           <div class="card-body">
             <div class="form-group mb-2">
               <label for="">`+quest.soal_kuesioner+`. `+quest.teks+`
             </div>
             <div class="form-check">
               <input class="form-check-input" type="radio" name="quest`+quest.soal_kuesioner+`" id="flexRadioDefault1" value="`+quest.list_jawaban[0].jawaban_kuesioner+`">
               <label class="form-check-label" for="flexRadioDefault1">
                 `+quest.list_jawaban[0].teks+`
               </label>
             </div>
             <div class="form-check">
               <input class="form-check-input" type="radio" name="quest`+quest.soal_kuesioner+`" id="flexRadioDefault2" value="`+quest.list_jawaban[1].jawaban_kuesioner+`">
               <label class="form-check-label" for="flexRadioDefault2">
                 `+quest.list_jawaban[1].teks+`
               </label>
             </div>
             <div class="form-check">
               <input class="form-check-input" type="radio" name="quest`+quest.soal_kuesioner+`" id="flexRadioDefault2" value="`+quest.list_jawaban[2].jawaban_kuesioner+`">
               <label class="form-check-label" for="flexRadioDefault2">
                 `+quest.list_jawaban[2].teks+`
               </label>
             </div>
             <div class="form-check">
               <input class="form-check-input" type="radio" name="quest`+quest.soal_kuesioner+`" id="flexRadioDefault2" value="`+quest.list_jawaban[3].jawaban_kuesioner+`">
               <label class="form-check-label" for="flexRadioDefault2">
                 `+quest.list_jawaban[3].teks+`
               </label>
             </div>
           </div>
         </div>`;
       }

       element.innerHTML += '<div class="d-grid gap-2 col-6 mx-auto"><button class="btn btn-success" type="button" onclick="beginsubmit()">Submit</button></div>';
       
       if(jenis == 'ppih') {
        document.getElementById("questioner").style.display = "";
        document.getElementById("choicekepala").style.display = "none"; 
       }else if(jenis == 'pimpinan' || jenis == 'tim') {
        document.getElementById("questioner").style.display = "";
        document.getElementById("choicepelaksana").style.display = "none"; 
       }

       Swal.hideLoading();
       
    })
    .catch((error) => {
      Swal.fire({
        title: "Terdapat gangguan koneksi. Silahkan coba lagi.",
        confirmButtonText: "Muat Ulang",
        denyButtonText: "Kembali"
        }).then((result) => {
        if (result.isConfirmed) {
            location.reload();
        } 
        });
    });

  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
   }

  function parseJwt(token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));

    return JSON.parse(jsonPayload);
   }
  </script>
</body>
</html>
